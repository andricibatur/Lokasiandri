<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekam Lokasi</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .blink-red { animation: blinkRed 1s infinite; }
    .blink-green { animation: blinkGreen 1s infinite; }
    @keyframes blinkRed {
      0% { background: #fff; }
      50% { background: red; color: #fff; }
      100% { background: #fff; }
    }
    @keyframes blinkGreen {
      0% { background: #fff; }
      50% { background: green; color: #fff; }
      100% { background: #fff; }
    }
  </style>
</head>
<body>
  <h2>Rekam Lokasi</h2>
  <label>Koordinat: </label>
  <input type="text" id="coords" readonly><button id="getLocation">Rekam Lokasi</button><br><br>
  <label>Keterangan: </label>
  <input type="text" id="desc"><br><br>
  <label>Jumlah: </label>
  <input type="number" id="amount"><br><br>
  <button id="save">Simpan</button>

  <h3>Laporan Lokasi</h3>
  <table id="report">
    <thead>
      <tr>
        <th>Koordinat</th>
        <th>Keterangan</th>
        <th>Jumlah</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let db;
    const request = indexedDB.open("lokasiDB", 1);
    request.onerror = e => console.error(e.target.error);
    request.onupgradeneeded = e => {
      db = e.target.result;
      db.createObjectStore("lokasi", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
      db = e.target.result;
      displayData();
      trackPosition();
    };

    document.getElementById("getLocation").onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        document.getElementById("coords").value = `${lat},${lon}`;
      });
    };

    document.getElementById("save").onclick = () => {
      const coords = document.getElementById("coords").value;
      const desc = document.getElementById("desc").value;
      const amount = parseInt(document.getElementById("amount").value);
      if (!coords || !desc || isNaN(amount)) {
        alert("Lengkapi semua data!");
        return;
      }
      const tx = db.transaction("lokasi", "readwrite");
      tx.objectStore("lokasi").add({ coords, desc, amount });
      tx.oncomplete = () => {
        displayData();
        document.getElementById("coords").value = '';
        document.getElementById("desc").value = '';
        document.getElementById("amount").value = '';
      };
    };

    function displayData() {
      const tbody = document.querySelector("#report tbody");
      tbody.innerHTML = "";
      const tx = db.transaction("lokasi", "readonly");
      const store = tx.objectStore("lokasi");
      store.openCursor().onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const tr = document.createElement("tr");
          tr.dataset.coords = cursor.value.coords;
          tr.innerHTML = `<td>${cursor.value.coords}</td>
                          <td>${cursor.value.desc}</td>
                          <td>${cursor.value.amount}</td>`;
          tbody.appendChild(tr);
          cursor.continue();
        }
      };
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLon = (lon2 - lon1) * rad;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*rad) * Math.cos(lat2*rad) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function trackPosition() {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        document.querySelectorAll("#report tbody tr").forEach(row => {
          const [rLat, rLon] = row.dataset.coords.split(",").map(Number);
          const dist = getDistance(lat, lon, rLat, rLon);
          row.classList.remove("blink-red", "blink-green");
          if (dist < 5) {
            row.classList.add("blink-green");
          } else if (dist < 50) {
            row.classList.add("blink-red");
          }
        });
      });
    }
  </script>
</body>
</html>
