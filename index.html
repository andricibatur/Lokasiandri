<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekam Lokasi dengan Jarak</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 10px; 
      max-width: 100%; 
      overflow-x: hidden;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
      font-size: 14px;
    }
    td, th { 
      border: 1px solid #ccc; 
      padding: 6px; 
      text-align: left; 
      word-break: break-word;
    }
    .blink-red { animation: blinkRed 1s infinite; }
    .blink-green { animation: blinkGreen 1s infinite; }
    @keyframes blinkRed {
      0% { background: #fff; }
      50% { background: red; color: #fff; }
      100% { background: #fff; }
    }
    @keyframes blinkGreen {
      0% { background: #fff; }
      50% { background: green; color: #fff; }
      100% { background: #fff; }
    }
    .completed { background-color: #f0f0f0; color: #888; }
    .history { display: none; background-color: #f9f9f9; }
    button {
      padding: 8px 12px;
      margin: 5px 0;
      font-size: 14px;
    }
    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      display: flex;
    }
    .tab button {
      flex: 1;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px;
      transition: 0.3s;
    }
    .tab button.active {
      background-color: #ddd;
    }
    .tabcontent {
      display: none;
      padding: 6px;
      border: 1px solid #ccc;
      border-top: none;
    }
    .tabcontent.active {
      display: block;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
    .action-buttons button {
      flex: 1;
    }
  </style>
</head>
<body>
  <h2>Rekam Lokasi</h2>
  
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'inputTab')">Input</button>
    <button class="tablinks" onclick="openTab(event, 'reportTab')">Laporan</button>
    <button class="tablinks" onclick="openTab(event, 'completedTab')">Selesai</button>
    <button class="tablinks" onclick="openTab(event, 'dataTab')">Data</button>
  </div>

  <!-- Input Tab -->
  <div id="inputTab" class="tabcontent active">
    <div class="form-group">
      <label>Koordinat: </label>
      <div style="display: flex; gap: 5px;">
        <input type="text" id="coords" readonly style="flex: 1;">
        <button id="getLocation">Rekam</button>
      </div>
    </div>
    <div class="form-group">
      <label>Keterangan: </label>
      <input type="text" id="desc">
    </div>
    <div class="form-group">
      <label>Jumlah: </label>
      <input type="number" id="amount">
    </div>
    <button id="save">Simpan</button>
  </div>

  <!-- Report Tab -->
  <div id="reportTab" class="tabcontent">
    <h3>Laporan Lokasi</h3>
    <div class="action-buttons">
      <button id="showHistory">Riwayat</button>
      <button id="completeSelected">Tandai Selesai</button>
    </div>
    <table id="report">
      <thead>
        <tr>
          <th width="30px"></th>
          <th>Koordinat</th>
          <th>Keterangan</th>
          <th>Jumlah</th>
          <th>Jarak (m)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Completed Tab -->
  <div id="completedTab" class="tabcontent">
    <h3>Laporan Selesai</h3>
    <div class="action-buttons">
      <button id="restoreSelected">Kembalikan</button>
    </div>
    <table id="completedReport">
      <thead>
        <tr>
          <th width="30px"></th>
          <th>Koordinat</th>
          <th>Keterangan</th>
          <th>Jumlah</th>
          <th>Jarak (m)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Data Tab -->
  <div id="dataTab" class="tabcontent">
    <h3>Kelola Data</h3>
    <div class="form-group">
      <label>Nama File:</label>
      <input type="text" id="fileName" placeholder="nama_file_tanpa_ekstensi">
    </div>
    <div class="action-buttons">
      <button id="exportData">Export Data</button>
      <button id="importData">Import Data</button>
    </div>
    <input type="file" id="fileInput" style="display: none;" accept=".json">
  </div>

  <script>
    let db;
    let showHistory = false;
    const request = indexedDB.open("lokasiDB", 2);
    
    request.onerror = e => console.error(e.target.error);
    
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("lokasi")) {
        db.createObjectStore("lokasi", { keyPath: "id", autoIncrement: true });
      }
      if (!db.objectStoreNames.contains("completed")) {
        db.createObjectStore("completed", { keyPath: "id", autoIncrement: true });
      }
      if (!db.objectStoreNames.contains("history")) {
        const historyStore = db.createObjectStore("history", { keyPath: "id", autoIncrement: true });
        historyStore.createIndex("locationId", "locationId", { unique: false });
      }
    };
    
    request.onsuccess = e => {
      db = e.target.result;
      displayData();
      displayCompletedData();
      trackPosition();
      
      // Migrasi data jika diperlukan
      migrateDataIfNeeded();
    };

    function migrateDataIfNeeded() {
      // Jika versi sebelumnya (1) hanya memiliki store "lokasi"
      const tx = db.transaction(["lokasi"], "readonly");
      const store = tx.objectStore("lokasi");
      store.getAll().onsuccess = function(e) {
        const allData = e.target.result;
        if (allData && allData.length > 0 && !allData[0].hasOwnProperty('completed')) {
          // Migrasi data ke struktur baru
          const migrateTx = db.transaction(["lokasi", "completed", "history"], "readwrite");
          const lokasiStore = migrateTx.objectStore("lokasi");
          const completedStore = migrateTx.objectStore("completed");
          const historyStore = migrateTx.objectStore("history");
          
          allData.forEach(item => {
            if (item.completed) {
              // Pindahkan ke completed
              const newItem = {...item};
              delete newItem.id;
              completedStore.add(newItem);
              lokasiStore.delete(item.id);
            }
          });
        }
      };
    }

    document.getElementById("getLocation").onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        document.getElementById("coords").value = `${lat},${lon}`;
      }, null, { enableHighAccuracy: true });
    };

    document.getElementById("save").onclick = () => {
      const coords = document.getElementById("coords").value;
      const desc = document.getElementById("desc").value;
      const amount = parseInt(document.getElementById("amount").value);
      if (!coords || !desc || isNaN(amount)) {
        alert("Lengkapi semua data!");
        return;
      }
      
      const tx = db.transaction(["lokasi", "history"], "readwrite");
      const lokasiStore = tx.objectStore("lokasi");
      const historyStore = tx.objectStore("history");
      
      const newItem = { 
        coords, 
        desc, 
        amount,
        timestamp: new Date().toISOString(),
        completed: false
      };
      
      const request = lokasiStore.add(newItem);
      
      request.onsuccess = function(e) {
        const locationId = e.target.result;
        // Tambahkan ke history
        historyStore.add({
          locationId,
          action: "created",
          timestamp: new Date().toISOString(),
          data: newItem
        });
      };
      
      tx.oncomplete = () => {
        displayData();
        document.getElementById("coords").value = '';
        document.getElementById("desc").value = '';
        document.getElementById("amount").value = '';
      };
    };

    function displayData(rows = []) {
      const tbody = document.querySelector("#report tbody");
      tbody.innerHTML = "";
      rows.forEach(row => tbody.appendChild(row));
    }

    function displayCompletedData(rows = []) {
      const tbody = document.querySelector("#completedReport tbody");
      tbody.innerHTML = "";
      rows.forEach(row => tbody.appendChild(row));
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLon = (lon2 - lon1) * rad;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*rad) * Math.cos(lat2*rad) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function trackPosition() {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        
        // Update active locations
        const tx = db.transaction("lokasi", "readonly");
        const store = tx.objectStore("lokasi");
        const rows = [];
        
        store.openCursor().onsuccess = e => {
          const cursor = e.target.result;
          if (cursor) {
            const [rLat, rLon] = cursor.value.coords.split(",").map(Number);
            const dist = getDistance(lat, lon, rLat, rLon);
            const tr = document.createElement("tr");
            tr.dataset.id = cursor.value.id;
            tr.innerHTML = `
              <td><input type="checkbox" class="select-row"></td>
              <td>${cursor.value.coords}</td>
              <td>${cursor.value.desc}</td>
              <td>${cursor.value.amount}</td>
              <td>${Math.round(dist)} m</td>`;
              
            // Add history row
            const historyRow = document.createElement("tr");
            historyRow.className = "history";
            historyRow.dataset.id = cursor.value.id;
            historyRow.innerHTML = `
              <td colspan="5">
                <small>Dibuat: ${new Date(cursor.value.timestamp).toLocaleString()}</small>
                <button onclick="showLocationHistory(${cursor.value.id})">Lihat Riwayat</button>
                <div id="history-${cursor.value.id}"></div>
              </td>`;
              
            tr.classList.remove("blink-red", "blink-green");
            if (dist < 5) {
              tr.classList.add("blink-green");
            } else if (dist < 900) {
              tr.classList.add("blink-red");
            }
            tr.dataset.dist = dist;
            rows.push(tr);
            
            if (showHistory) {
              rows.push(historyRow);
            }
            
            cursor.continue();
          } else {
            rows.sort((a,b) => a.dataset.dist - b.dataset.dist);
            displayData(rows);
          }
        };
        
        // Update completed locations
        const completedTx = db.transaction("completed", "readonly");
        const completedStore = completedTx.objectStore("completed");
        const completedRows = [];
        
        completedStore.openCursor().onsuccess = e => {
          const cursor = e.target.result;
          if (cursor) {
            const [rLat, rLon] = cursor.value.coords.split(",").map(Number);
            const dist = getDistance(lat, lon, rLat, rLon);
            const tr = document.createElement("tr");
            tr.className = "completed";
            tr.dataset.id = cursor.value.id;
            tr.innerHTML = `
              <td><input type="checkbox" class="select-row"></td>
              <td>${cursor.value.coords}</td>
              <td>${cursor.value.desc}</td>
              <td>${cursor.value.amount}</td>
              <td>${Math.round(dist)} m</td>`;
            completedRows.push(tr);
            cursor.continue();
          } else {
            completedRows.sort((a,b) => a.dataset.dist - b.dataset.dist);
            displayCompletedData(completedRows);
          }
        };
      }, null, { enableHighAccuracy: true });
    }

    // Tab functionality
    function openTab(evt, tabName) {
      const tabcontents = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontents.length; i++) {
        tabcontents[i].classList.remove("active");
      }
      
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
      }
      
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
      
      // Refresh data when switching tabs
      if (tabName === 'reportTab') {
        displayData();
      } else if (tabName === 'completedTab') {
        displayCompletedData();
      }
    }

    // Export/Import functionality
    document.getElementById("exportData").onclick = function() {
      const fileName = document.getElementById("fileName").value || 'lokasi_data';
      
      const tx = db.transaction(["lokasi", "completed", "history"], "readonly");
      const lokasiStore = tx.objectStore("lokasi");
      const completedStore = tx.objectStore("completed");
      const historyStore = tx.objectStore("history");
      
      Promise.all([
        new Promise(resolve => {
          lokasiStore.getAll().onsuccess = e => resolve({ lokasi: e.target.result });
        }),
        new Promise(resolve => {
          completedStore.getAll().onsuccess = e => resolve({ completed: e.target.result });
        }),
        new Promise(resolve => {
          historyStore.getAll().onsuccess = e => resolve({ history: e.target.result });
        })
      ]).then(results => {
        const data = Object.assign({}, ...results);
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    };

    document.getElementById("importData").onclick = function() {
      if (confirm("Import data akan menimpa data yang ada. Lanjutkan?")) {
        document.getElementById("fileInput").click();
      }
    };

    document.getElementById("fileInput").onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          const tx = db.transaction(["lokasi", "completed", "history"], "readwrite");
          const lokasiStore = tx.objectStore("lokasi");
          const completedStore = tx.objectStore("completed");
          const historyStore = tx.objectStore("history");
          
          // Clear existing data
          lokasiStore.clear();
          completedStore.clear();
          historyStore.clear();
          
          // Import new data
          if (data.lokasi) {
            data.lokasi.forEach(item => lokasiStore.add(item));
          }
          if (data.completed) {
            data.completed.forEach(item => completedStore.add(item));
          }
          if (data.history) {
            data.history.forEach(item => historyStore.add(item));
          }
          
          tx.oncomplete = function() {
            alert("Data berhasil diimport!");
            displayData();
            displayCompletedData();
          };
        } catch (err) {
          alert("Error parsing file: " + err.message);
        }
      };
      reader.readAsText(file);
    };

    // Toggle history visibility
    document.getElementById("showHistory").onclick = function() {
      showHistory = !showHistory;
      this.textContent = showHistory ? "Sembunyikan Riwayat" : "Riwayat";
      displayData();
    };

    // Show location history
    function showLocationHistory(locationId) {
      const historyDiv = document.getElementById(`history-${locationId}`);
      const tx = db.transaction("history", "readonly");
      const store = tx.objectStore("history");
      const index = store.index("locationId");
      
      historyDiv.innerHTML = "<p>Memuat riwayat...</p>";
      
      const request = index.getAll(locationId);
      request.onsuccess = function(e) {
        const historyItems = e.target.result;
        if (historyItems.length === 0) {
          historyDiv.innerHTML = "<p>Tidak ada riwayat</p>";
          return;
        }
        
        let html = "<ul>";
        historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        historyItems.forEach(item => {
          html += `<li>${item.action} - ${new Date(item.timestamp).toLocaleString()}</li>`;
        });
        html += "</ul>";
        historyDiv.innerHTML = html;
      };
    }

    // Mark selected as completed
    document.getElementById("completeSelected").onclick = function() {
      const checkboxes = document.querySelectorAll("#report tbody .select-row:checked");
      if (checkboxes.length === 0) {
        alert("Pilih minimal satu item!");
        return;
      }
      
      if (!confirm(`Anda yakin ingin menandai ${checkboxes.length} item sebagai selesai?`)) {
        return;
      }
      
      const tx = db.transaction(["lokasi", "completed", "history"], "readwrite");
      const lokasiStore = tx.objectStore("lokasi");
      const completedStore = tx.objectStore("completed");
      const historyStore = tx.objectStore("history");
      
      let processed = 0;
      checkboxes.forEach(checkbox => {
        const row = checkbox.closest("tr");
        const id = parseInt(row.dataset.id);
        
        lokasiStore.get(id).onsuccess = function(e) {
          const item = e.target.result;
          if (item) {
            // Add to completed
            const newItem = {...item};
            delete newItem.id;
            completedStore.add(newItem).onsuccess = function() {
              // Add to history
              historyStore.add({
                locationId: id,
                action: "completed",
                timestamp: new Date().toISOString(),
                data: newItem
              });
              
              // Delete from lokasi
              lokasiStore.delete(id);
              
              processed++;
              if (processed === checkboxes.length) {
                displayData();
                displayCompletedData();
              }
            };
          }
        };
      });
    };

    // Restore selected from completed
    document.getElementById("restoreSelected").onclick = function() {
      const checkboxes = document.querySelectorAll("#completedReport tbody .select-row:checked");
      if (checkboxes.length === 0) {
        alert("Pilih minimal satu item!");
        return;
      }
      
      if (!confirm(`Anda yakin ingin mengembalikan ${checkboxes.length} item ke laporan?`)) {
        return;
      }
      
      const tx = db.transaction(["lokasi", "completed", "history"], "readwrite");
      const lokasiStore = tx.objectStore("lokasi");
      const completedStore = tx.objectStore("completed");
      const historyStore = tx.objectStore("history");
      
      let processed = 0;
      checkboxes.forEach(checkbox => {
        const row = checkbox.closest("tr");
        const id = parseInt(row.dataset.id);
        
        completedStore.get(id).onsuccess = function(e) {
          const item = e.target.result;
          if (item) {
            // Add back to lokasi
            const newItem = {...item};
            delete newItem.id;
            lokasiStore.add(newItem).onsuccess = function(addResult) {
              // Add to history
              historyStore.add({
                locationId: addResult.target.result,
                action: "restored",
                timestamp: new Date().toISOString(),
                data: newItem
              });
              
              // Delete from completed
              completedStore.delete(id);
              
              processed++;
              if (processed === checkboxes.length) {
                displayData();
                displayCompletedData();
              }
            };
          }
        };
      });
    };

    // Warn before closing if there are unsaved changes
    window.addEventListener('beforeunload', function(e) {
      // You could add logic here to check for unsaved changes
      // For now, we'll just always warn
      e.preventDefault();
      e.returnValue = 'Anda mungkin memiliki perubahan yang belum disimpan. Yakin ingin meninggalkan halaman?';
    });
  </script>
</body>
</html>
