<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chatbot Mistral - Aman</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #chatLog { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
    #inputBox { width: 100%; margin-top: 10px; }
    #controls { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>

<h2>🤖 Chatbot Mistral (OpenRouter)</h2>
<div id="chatLog"></div>
<textarea id="inputBox" rows="2" placeholder="Tulis pesan..."></textarea>
<div id="controls">
  <button id="sendBtn">Kirim</button>
  <button id="exportBtn">Ekspor</button>
  <button id="importBtn">Impor</button>
  <input type="file" id="importFile" accept=".json" style="display:none">
</div>

<script>
const API_KEY = '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'; // 🔁 GANTI dengan API Key Inul
const MODEL = 'mistralai/mistral-7b-instruct';
const MAX_TOKENS = 1000;

const chatLog = document.getElementById('chatLog');
const inputBox = document.getElementById('inputBox');
const sendBtn = document.getElementById('sendBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');

let db;
const request = indexedDB.open('ChatDB', 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains('messages')) {
    db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
  }
};
request.onsuccess = e => { db = e.target.result; loadChat(); };
request.onerror = e => console.error('DB Error:', e);

function save(role, content) {
  const tx = db.transaction('messages', 'readwrite');
  tx.objectStore('messages').add({ role, content, time: Date.now() });
}

function print(role, content) {
  const div = document.createElement('div');
  div.textContent = (role === 'user' ? '🧍: ' : '🤖: ') + content;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
  save(role, content);
}

function loadChat() {
  const tx = db.transaction('messages', 'readonly');
  tx.objectStore('messages').getAll().onsuccess = e => {
    e.target.result.forEach(msg => print(msg.role, msg.content));
  };
}

sendBtn.onclick = async () => {
  const msg = inputBox.value.trim();
  if (!msg) return;
  print('user', msg);
  inputBox.value = '';

  try {
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [{ role: 'user', content: msg }],
        max_tokens: MAX_TOKENS
      })
    });

    const data = await res.json();
    if (data.error) {
      print('assistant', '⚠️ Error: ' + data.error.message);
    } else if (!data.choices || !data.choices[0]) {
      print('assistant', '⚠️ Tidak ada balasan dari model.');
    } else {
      const reply = data.choices[0].message.content;
      print('assistant', reply);
    }
  } catch (err) {
    print('assistant', '⚠️ Gagal fetch: ' + err.message);
  }
};

exportBtn.onclick = () => {
  const tx = db.transaction('messages', 'readonly');
  tx.objectStore('messages').getAll().onsuccess = e => {
    const data = JSON.stringify(e.target.result);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'chat-history.json';
    a.click();
  };
};

importBtn.onclick = () => importFile.click();
importFile.onchange = () => {
  const file = importFile.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const msgs = JSON.parse(e.target.result);
      const tx = db.transaction('messages', 'readwrite');
      msgs.forEach(msg => tx.objectStore('messages').add(msg));
      setTimeout(() => {
        chatLog.innerHTML = '';
        loadChat();
      }, 500);
    } catch (e) {
      alert('Gagal impor: ' + e.message);
    }
  };
  reader.readAsText(file);
};
</script>
</body>
</html>
