<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chatbot OpenRouter</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #chatLog { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
    #inputBox { width: 80%; }
    #sendBtn { padding: 5px 10px; }
  </style>
</head>
<body>

<h1>Chatbot OpenRouter</h1>
<div id="chatLog"></div>
<textarea id="inputBox" rows="2" placeholder="Tulis pesan..."></textarea>
<button id="sendBtn">Kirim</button>
<button id="exportBtn">Ekspor Obrolan</button>
<input type="file" id="importFile" style="display:none;" accept=".json"/>
<button id="importBtn">Impor Obrolan</button>

<script>
// Ganti <OPENROUTER_API_KEY> dengan kunci API Anda.
const API_KEY = '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';
const chatLog = document.getElementById('chatLog');
const inputBox = document.getElementById('inputBox');
const sendBtn = document.getElementById('sendBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');

// Inisialisasi IndexedDB untuk menyimpan pesan
let db;
const request = indexedDB.open('ChatDB', 1);
request.onupgradeneeded = function(e) {
  db = e.target.result;
  if (!db.objectStoreNames.contains('messages')) {
    db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
  }
};
request.onsuccess = function(e) { db = e.target.result; loadChatHistory(); };
request.onerror = function(e) { console.error('IndexedDB error:', e); };

// Fungsi menyimpan pesan ke IndexedDB
function saveMessage(role, content) {
  const tx = db.transaction('messages', 'readwrite');
  const store = tx.objectStore('messages');
  store.add({ role, content, timestamp: Date.now() });
}

// Menampilkan pesan ke layar dan simpan ke DB
function addChatLine(role, content) {
  const div = document.createElement('div');
  div.textContent = (role === 'user' ? 'Anda: ' : 'Bot: ') + content;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
  saveMessage(role, content);
}

// Memuat riwayat obrolan dari IndexedDB saat halaman dibuka
function loadChatHistory() {
  const tx = db.transaction('messages', 'readonly');
  const store = tx.objectStore('messages');
  const requestAll = store.getAll();
  requestAll.onsuccess = function() {
    const allMsgs = requestAll.result;
    allMsgs.sort((a,b) => a.id - b.id).forEach(msg => {
      const div = document.createElement('div');
      div.textContent = (msg.role === 'user' ? 'Anda: ' : 'Bot: ') + msg.content;
      chatLog.appendChild(div);
    });
    chatLog.scrollTop = chatLog.scrollHeight;
  };
}

// Pengiriman pesan pengguna
sendBtn.onclick = async () => {
  const text = inputBox.value.trim();
  if (!text) return;
  addChatLine('user', text);
  inputBox.value = '';
  // Panggil OpenRouter API
  try {
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'openai/gpt-4o',
        messages: [{ role: 'user', content: text }]
      })
    });
    const data = await response.json();
    const botReply = data.choices[0].message.content;
    addChatLine('assistant', botReply);
  } catch (err) {
    addChatLine('assistant', 'Error: ' + err.message);
  }
};

// Ekspor riwayat obrolan ke file JSON
exportBtn.onclick = async () => {
  const tx = db.transaction('messages', 'readonly');
  const store = tx.objectStore('messages');
  const requestAll = store.getAll();
  requestAll.onsuccess = function() {
    const allMsgs = requestAll.result;
    const blob = new Blob([JSON.stringify(allMsgs)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'obrolan.json';
    a.click();
    URL.revokeObjectURL(url);
  };
};

// Impor riwayat obrolan dari file JSON
importBtn.onclick = () => importFile.click();
importFile.onchange = () => {
  const file = importFile.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const msgs = JSON.parse(e.target.result);
      const tx = db.transaction('messages', 'readwrite');
      const store = tx.objectStore('messages');
      msgs.forEach(msg => store.add(msg));
      // Reload chat after impor
      chatLog.innerHTML = '';
      loadChatHistory();
    } catch(err) {
      alert('Gagal mengimpor: ' + err);
    }
  };
  reader.readAsText(file);
};
</script>
</body>
</html>
