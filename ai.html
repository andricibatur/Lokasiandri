<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Catatan Keuangan AI DeepSeek</title>
  <style>
    body { font-family: sans-serif; margin: 15px; }
    textarea, pre { width: 100%; box-sizing: border-box; }
    textarea { height: 100px; margin-top: 5px; }
    #controls { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    #aiResult { background: #f9f9f9; padding: 10px; margin-top: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h3>📒 Catatan Keuangan Cerdas (DeepSeek)</h3>
<label>✍️ Catatan Baru:</label>
<textarea id="input" placeholder="Contoh: 25 Jun - Jual kambing 2jt [+]"></textarea>

<div id="controls">
  <button onclick="simpan()">💾 Simpan</button>
  <button onclick="tanyaAI()">🤖 Tanya ke AI</button>
  <button onclick="exportJSON()">📤 Ekspor JSON</button>
  <button onclick="printLaporan()">🖨️ Cetak Laporan</button>
</div>

<h4>📋 Hasil AI:</h4>
<pre id="aiResult">(belum ada)</pre>

<script>
const API_KEY = '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'; // 🔁 Ganti dengan API Key Inul
const MODEL = 'deepseek/deepseek-chat-v3';
const MAX_TOKENS = 1000;

// IndexedDB setup
let db;
const req = indexedDB.open('CatatanKeuangan', 1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore('catatan', { keyPath: 'id', autoIncrement: true });
};
req.onsuccess = e => { db = e.target.result; };
req.onerror = e => alert('IndexedDB gagal');

// Simpan catatan ke IndexedDB
function simpan() {
  const isi = document.getElementById('input').value.trim();
  if (!isi) return alert('Isi catatan kosong');
  const tx = db.transaction('catatan', 'readwrite');
  tx.objectStore('catatan').add({ isi, waktu: Date.now() });
  document.getElementById('input').value = '';
  alert('✅ Disimpan!');
}

// Ambil semua catatan dari IndexedDB
function ambilSemua(callback) {
  const tx = db.transaction('catatan', 'readonly');
  const store = tx.objectStore('catatan');
  const req = store.getAll();
  req.onsuccess = () => callback(req.result.map(c => c.isi).join('\n'));
}

// Kirim ke AI
async function tanyaAI() {
  document.getElementById('aiResult').textContent = '⏳ Menghubungi AI...';
  ambilSemua(async (semuaCatatan) => {
    try {
      const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: MODEL,
          messages: [
            { role: 'system', content: 'Kamu adalah asisten keuangan. Baca semua catatan dan buatkan ringkasan pemasukan, pengeluaran, dan saldo akhir.' },
            { role: 'user', content: semuaCatatan }
          ],
          max_tokens: MAX_TOKENS
        })
      });

      const data = await res.json();
      const hasil = data.choices?.[0]?.message?.content || (data.error?.message || '❌ Gagal mendapatkan jawaban');
      document.getElementById('aiResult').textContent = hasil;
    } catch (err) {
      document.getElementById('aiResult').textContent = '❌ Error jaringan atau server: ' + err.message;
    }
  });
}

// Ekspor data
function exportJSON() {
  const tx = db.transaction('catatan', 'readonly');
  tx.objectStore('catatan').getAll().onsuccess = e => {
    const data = JSON.stringify(e.target.result, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'catatan-keuangan.json';
    a.click();
  };
}

// Cetak laporan
function printLaporan() {
  const isi = document.getElementById('aiResult').textContent;
  if (!isi || isi === '(belum ada)') return alert('Tidak ada laporan untuk dicetak');
  const w = window.open();
  w.document.write('<pre>' + isi + '</pre>');
  w.print();
}
</script>

</body>
</html>
